data "cloudflare_zones" "op_domain" {
  filter {
    name = "{{ warhorse.dns.op_tld }}"
  }
}
{% for vm in warhorse.vm %}
resource "cloudflare_record" "{{ vm.name }}" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  name    = "{{ vm.name }}.{{ warhorse.general.op_number }}"
  value   = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  type    = "A"
  ttl     = 3600
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}

{% if vm.cobaltstrike is defined %}
resource "cloudflare_record" "{{ vm.name }}_cobaltstrike" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  name    = "cs-{{ vm.name }}.{{ warhorse.general.op_number }}"
  value   = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  type    = "A"
  ttl     = 3600
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}
{% endif %}
{% if vm.nighthawk is defined %}
resource "cloudflare_record" "{{ vm.name }}_nighthawk" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  name    = "nh-{{ vm.name }}.{{ warhorse.general.op_number }}"
  value   = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  type    = "A"
  ttl     = 3600
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}
{% endif %}
{% if vm.mythic is defined %}
resource "cloudflare_record" "{{ vm.name }}_mythic" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  type   = "A"
  name   = "mythic-{{ vm.name }}.{{ warhorse.general.op_number }}"
  value  = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}
{% endif %}
{% if vm.gophish is defined %}
resource "cloudflare_record" "{{ vm.name }}_gophish_site" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  type   = "A"
  name   = "{{ vm.gophish.site_hostname }}.{{ warhorse.general.op_number }}"
  value  = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}
resource "cloudflare_record" "{{ vm.name }}_gophish_admin" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  type   = "A"
  name   = "{{ vm.gophish.admin_hostname }}.{{ warhorse.general.op_number }}"
  value  = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}
{% endif %}
{% if vm.cobaltstrike.dns_over_https is true %}
resource "cloudflare_record" "{{ vm.name }}_ns" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  type   = "NS"
  name   = "ns1.{{ warhorse.general.op_number }}"
  value  = "dns.{{ warhorse.dns.op_domain_name|default(dns_op_domain_name) }}."
}
resource "cloudflare_record" "{{ vm.name }}_ns_record" {
  zone_id = data.cloudflare_zones.op_domain.zones[0].id
  type   = "A"
  name   = "dns.{{ warhorse.general.op_number }}"
  value  = digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}.ipv4_address
  depends_on = [digitalocean_droplet.{{ vm.resource_name|default(warhorse.general.user_tag + '-' + warhorse.general.op_number + '-' + vm.name) }}]
}
{% endif %}
{% endfor %}